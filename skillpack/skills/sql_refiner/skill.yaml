skill:
  name: "sql-refiner"
  version: "0.1.0"
  description: "Generate SQL queries from natural language questions with dialect-specific syntax"
  tags: ["sql", "query", "postgres", "bigquery", "snowflake", "natural-language"]

command:
  template: "skillpack sql-refiner --question {question} --dialect {dialect}"
  binary: "skillpack"
  subcommand: "sql-refiner"
  arguments:
    question:
      type: "string"
      required: true
      cli_name: "--question"
      description: "Natural language question to convert to SQL"
      validation:
        min_length: 5
        max_length: 500
    dialect:
      type: "enum"
      required: false
      cli_name: "--dialect"
      default: "postgres"
      enum: ["postgres", "bigquery", "snowflake"]
      description: "Target SQL dialect"

output:
  base_directory: "./out/sql_refiner/"
  files:
    - path: "query.sql"
      type: "sql"
      description: "Generated SQL query with placeholders"
    - path: "explain.sql"
      type: "sql"
      description: "EXPLAIN query for performance analysis"
    - path: "query_notes.md"
      type: "markdown"
      description: "Query documentation and usage notes"
      sections:
        - "Original question"
        - "Detected entities (aggregations, filters)"
        - "Placeholders to replace"
        - "Performance tips"

guardrails:
  allowed:
    - "Parse natural language question"
    - "Generate SQL query templates"
    - "Write to ./out/sql_refiner/"
  forbidden:
    - "Execute SQL queries"
    - "Connect to any database"
    - "Access credentials or connection strings"
    - "Modify any files outside ./out/"
    - "Make network requests"
    - "Include sensitive data in output"

preconditions:
  - description: "Question is provided"
    check: "question argument is non-empty string"
  - description: "Dialect is valid"
    check: "dialect is one of: postgres, bigquery, snowflake"

postconditions:
  - description: "SQL files are created"
    check: "query.sql, explain.sql, query_notes.md exist"
  - description: "SQL is syntactically valid"
    check: "query.sql contains valid SQL for specified dialect"
  - description: "Placeholders are documented"
    check: "query_notes.md lists placeholders to replace"

errors:
  empty_question:
    condition: "Question is empty or too short"
    message: "Question must be at least 5 characters"
    recovery: "Provide a more detailed question"
  invalid_dialect:
    condition: "Dialect not in supported list"
    message: "Unsupported dialect: {dialect}"
    recovery: "Use: postgres, bigquery, or snowflake"

entity_detection:
  aggregations:
    - pattern: ["count", "how many"]
      sql: "COUNT(*)"
    - pattern: ["sum", "total"]
      sql: "SUM(column)"
    - pattern: ["average", "avg", "mean"]
      sql: "AVG(column)"
    - pattern: ["maximum", "max", "highest", "largest"]
      sql: "MAX(column)"
    - pattern: ["minimum", "min", "lowest", "smallest"]
      sql: "MIN(column)"
  conditions:
    - pattern: "active"
      sql: "status = 'active'"
    - pattern: "last N days/weeks/months"
      sql: "created_at >= NOW() - INTERVAL 'N unit'"
  ordering:
    - pattern: ["top", "highest", "largest"]
      sql: "ORDER BY ... DESC"
    - pattern: ["bottom", "lowest", "smallest"]
      sql: "ORDER BY ... ASC"
  limits:
    - pattern: "top N"
      sql: "LIMIT N"

dialect_differences:
  postgres:
    string_agg: "STRING_AGG(col, ', ')"
    date_trunc: "DATE_TRUNC('unit', col)"
    ilike: "ILIKE"
  bigquery:
    string_agg: "STRING_AGG(col, ', ')"
    date_trunc: "DATE_TRUNC(col, unit)"
    ilike: "LIKE (case-insensitive by default)"
  snowflake:
    string_agg: "LISTAGG(col, ', ')"
    date_trunc: "DATE_TRUNC('unit', col)"
    ilike: "ILIKE"

examples:
  - name: "Count active users"
    description: "Simple aggregation query"
    input:
      question: "How many active users signed up in the last 30 days"
      dialect: "postgres"
    command: "skillpack sql-refiner --question \"How many active users signed up in the last 30 days\" --dialect postgres"
    expected_output:
      files_created:
        - "./out/sql_refiner/query.sql"
        - "./out/sql_refiner/explain.sql"
        - "./out/sql_refiner/query_notes.md"
      query_contains: ["COUNT", "WHERE", "status = 'active'"]
      
  - name: "Top orders BigQuery"
    description: "Top N query for BigQuery"
    input:
      question: "Get top 10 orders by amount"
      dialect: "bigquery"
    command: "skillpack sql-refiner --question \"Get top 10 orders by amount\" --dialect bigquery"
    expected_output:
      query_contains: ["LIMIT 10", "ORDER BY", "DESC"]

  - name: "Aggregation with grouping"
    description: "Group by and aggregate"
    input:
      question: "Calculate average order value per customer"
      dialect: "snowflake"
    command: "skillpack sql-refiner --question \"Calculate average order value per customer\" --dialect snowflake"
    expected_output:
      query_contains: ["AVG", "GROUP BY"]

related_skills:
  - name: "profile-dataset"
    reason: "Understand data before writing queries"
  - name: "schema-diff"
    reason: "Check schema compatibility"
