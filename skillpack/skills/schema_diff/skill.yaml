skill:
  name: "schema-diff"
  version: "0.1.0"
  description: "Compare database schemas and generate migration scripts with impact assessment"
  tags: ["schema", "migration", "database", "diff", "sql"]

command:
  template: "skillpack schema-diff --old {old_schema} --new {new_schema} --table {table_name}"
  binary: "skillpack"
  subcommand: "schema-diff"
  arguments:
    old_schema:
      type: "file_path"
      required: true
      cli_name: "--old"
      description: "Path to old schema JSON file"
      validation:
        file_must_exist: true
        extensions: [".json"]
    new_schema:
      type: "file_path"
      required: true
      cli_name: "--new"
      description: "Path to new schema JSON file"
      validation:
        file_must_exist: true
        extensions: [".json"]
    table_name:
      type: "string"
      required: false
      cli_name: "--table"
      default: "table_name"
      description: "Name of the table for migration statements"

input_schema:
  format: "json"
  structure:
    columns:
      type: "array"
      required: true
      items:
        name:
          type: "string"
          required: true
          description: "Column name"
        type:
          type: "string"
          required: true
          description: "SQL data type (e.g., INTEGER, VARCHAR(255))"
        nullable:
          type: "boolean"
          required: false
          default: true
          description: "Whether column allows NULL"
        pk:
          type: "boolean"
          required: false
          default: false
          description: "Whether column is part of primary key"

output:
  base_directory: "./out/schema_diff/"
  files:
    - path: "migration.sql"
      type: "sql"
      description: "Forward and rollback migration SQL"
      sections:
        - "Forward migration (ADD, ALTER, DROP columns)"
        - "Rollback migration (commented, reverse operations)"
    - path: "migration.md"
      type: "markdown"
      description: "Migration impact documentation"
      sections:
        - "Overview (table, schema files)"
        - "Changes Summary (added, removed, modified counts)"
        - "Added Columns (with types)"
        - "Removed Columns (with warning)"
        - "Modified Columns (before/after comparison)"
        - "Impact Assessment"
        - "Backfill Requirements"
        - "Rollback Plan"

guardrails:
  allowed:
    - "Read the specified schema JSON files"
    - "Parse JSON content"
    - "Compare schema structures"
    - "Generate SQL migration statements"
    - "Write to ./out/schema_diff/"
  forbidden:
    - "Execute SQL migrations"
    - "Connect to any database"
    - "Modify the input schema files"
    - "Delete any files"
    - "Make network requests"
    - "Apply migrations automatically"

preconditions:
  - description: "Both schema files exist"
    check: "old_schema and new_schema files exist"
  - description: "Files are valid JSON"
    check: "Both files can be parsed as JSON"
  - description: "Files have required structure"
    check: "Both files have 'columns' array"

postconditions:
  - description: "Migration files are created"
    check: "migration.sql and migration.md exist"
  - description: "Input files are unchanged"
    check: "Original schema files are not modified"
  - description: "All changes are documented"
    check: "Every diff is reflected in output"

errors:
  file_not_found:
    condition: "Schema file does not exist"
    message: "Schema file not found: {file_path}"
    recovery: "Check the file path"
  invalid_json:
    condition: "File is not valid JSON"
    message: "Unable to parse JSON: {file_path}"
    recovery: "Fix JSON syntax errors"
  missing_columns:
    condition: "No columns array in schema"
    message: "Schema missing 'columns' field"
    recovery: "Add 'columns' array to schema JSON"

diff_types:
  added_column:
    description: "New column in new schema"
    sql: "ALTER TABLE {table} ADD COLUMN {name} {type} [NOT NULL]"
    risk: "Low if nullable, Medium if NOT NULL"
  removed_column:
    description: "Column in old schema but not in new"
    sql: "ALTER TABLE {table} DROP COLUMN {name}"
    risk: "High - data loss, commented by default"
  type_changed:
    description: "Column type changed"
    sql: "ALTER TABLE {table} ALTER COLUMN {name} TYPE {new_type}"
    risk: "Medium - may fail if data incompatible"
  nullable_changed:
    description: "Nullable constraint changed"
    sql: "ALTER TABLE {table} ALTER COLUMN {name} SET/DROP NOT NULL"
    risk: "Medium if adding NOT NULL (requires backfill)"
  pk_changed:
    description: "Primary key status changed"
    risk: "High - requires careful migration"

examples:
  - name: "Add column migration"
    description: "Generate migration for adding a new column"
    input:
      old_schema: "schema_v1.json"
      new_schema: "schema_v2.json"
      table_name: "users"
    old_schema_content:
      columns:
        - {name: "id", type: "INTEGER", nullable: false, pk: true}
        - {name: "email", type: "VARCHAR(255)", nullable: false}
    new_schema_content:
      columns:
        - {name: "id", type: "INTEGER", nullable: false, pk: true}
        - {name: "email", type: "VARCHAR(255)", nullable: false}
        - {name: "name", type: "VARCHAR(100)", nullable: true}
    command: "skillpack schema-diff --old schema_v1.json --new schema_v2.json --table users"
    expected_output:
      migration_contains: "ADD COLUMN name VARCHAR(100)"
      
  - name: "Complex migration"
    description: "Multiple changes in one migration"
    input:
      old_schema: "v1.json"
      new_schema: "v2.json"
      table_name: "orders"
    command: "skillpack schema-diff --old v1.json --new v2.json --table orders"
    expected_output:
      files_created:
        - "./out/schema_diff/migration.sql"
        - "./out/schema_diff/migration.md"

related_skills:
  - name: "pr-summary"
    reason: "Include migration in PR summary"
  - name: "dbt-generator"
    reason: "Update dbt models for schema changes"
